# 电量优化目标和实践

## 概述：

不同对象，不同场景针对同一事物有着不同的目标和要求，我们是应用不是系统，我们面对的是用户而不是设备，所以我们只需要让用户感觉到我们的应用在耗电方面是正常的就足够了，

用户针对应用的耗电感知主要是是以下三个方面

1. Android9.0以上对于不符合电量使用规范的应用，系统将提醒用户限制该应用访问设备资源，就是我们常见的 高耗电提醒 ：”某某应用正在后台严重耗电“，出现这种情形的应用往往都伴随着用户的强行杀死和卸载
2. 在设置界面有个系统耗电排行，针对耗电排行，用户的期望是应用耗电排行应该和使用时长成正比，没有使用的应该完全不耗电，针对这种情况下，我们应该在应用处于后台时，尽可能的减少耗电，或者不耗电。
3. 使用应用期间，设备发热。一般设备发热都是高耗电引起的，高耗电除非是某些特殊情形，否者一般都是代码错误，或者硬件使用不当造成的，这种情况可总结为异常耗电

## 优化目标

针对上述，我们的电量优化目标总结如下：

1. 符合系统电量使用规则  
2. 降低后台耗电 
3. 监控异常耗电

**上述目标并不是独立存在的，而是相互交叉的，只是侧重点或者说是表现形式不同而已**

#### 1、系统电量使用规则

Android P新增后台限制功能，若应用出现 [Android Vitals](https://developer.android.google.cn/topic/performance/vitals) 内所描述的不良行为，系统将提醒用户限制该应用访问设备资源。

而Android Vitals 内所描述的不良行为如下：

![620748a58e45e50fdea1098f15c77d15](/Users/wangkunkun/Desktop/电量优化/620748a58e45e50fdea1098f15c77d15.png)

解决方案同下2

#### 2、降低后台耗电

即使Android P有了很严格的电源使用限制，但是某些情形下 我们还是可以在后台做耗电操作的

比如：各种推送保活 网络请求  唤醒锁 alarm  JobScheduler wifi scans 传感器 蓝牙，gps等等，下图是Android电源管理限制图

![截屏2020-08-24 下午6.01.56](/Users/wangkunkun/Desktop/电量优化/截屏2020-08-24 下午6.01.56.png)

降低后台耗电：一方面是优化当前代码，另一方面是监控预防

优化的方案：主要是“偷懒至上” ，即是：减少，延迟，合并

- **减少操作**：您的应用是否存在可删减的多余操作？例如，是否可以缓存已下载的数据，而不是反复唤醒无线装置来重新下载数据？
- **推迟操作**：应用是否需要立即执行某项操作？例如，是否可以等到设备充电后再将数据备份到云端？
- **合并操作**：工作是否可以批处理，而不是多次将设备置于活动状态？例如，是否真的有必要让数十个应用分别在不同时间打开无线装置发送消息？是否可以改为在无线装置单次唤醒期间传输消息？

监控预防：

后台网络操作，后台wifi scans ，后台蓝牙，alarm，后台wakelock，后台sensor，后台GPS，后台CPU

#### 3、异常耗电-监控

1. 单位时间内的 耗电异常增强，
2. 手机发热 一方面是电池的问题，一方面是cpu的温度

异常耗电关注的时机是整个app使用周期内，手机电量和温度的变化



#### 方案

综上：整个耗电优化，体现在两个方面。一、后台耗电任务代码优化，二、是电量耗电点监控

电量监控内容：

一、后台网络操作，后台wifi scans ，后台蓝牙，alarm，后台wakelock，后台sensor，后台GPS，后台CPU，

而监控标准为：[Android Vitals](https://developer.android.google.cn/topic/performance/vitals) 功耗标准和[绿色联盟功耗标准](https://www.china-sga.com/upload/doc/c4170daf956747f6bea1c9e20584239e/软件绿色联盟应用体验标准3.0_功耗标准V1.1.pdf)

二、异常耗电监控 

方式（1）Android 系统[热缓解](https://source.android.google.cn/devices/architecture/hidl/thermal-mitigation?hl=zh-cn) 监控Android设备表面温度

PowerManager [addThermalStatusListener()](https://android.googlesource.com/platform/frameworks/base/+/refs/heads/android10-release/core/java/android/os/PowerManager.java#1812)

![截屏2020-08-24 下午10.04.42](/Users/wangkunkun/Desktop/电量优化/截屏2020-08-24 下午10.04.42.png)

方式（2）循环 监听电池电流 电池温度 

实现方式：通过java hook和插装方式进行监控，参考方案[facebook的耗电监控](https://github.com/facebookincubator/Battery-Metrics)   



后台耗电任务代码优化：

获取后台耗电的地方

​       1，测试通过adb获取应用在后台一段时间的耗电信息，然后进行分析

​        2，通过监控获取耗电异常的地方

代码优化：

通过上述的 减少，延迟，合并方式进行优化后台任务耗电

























